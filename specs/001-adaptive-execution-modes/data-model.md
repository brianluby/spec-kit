# Data Model: Adaptive Execution Modes

**Branch**: `001-adaptive-execution-modes` | **Date**: 2026-02-21

## Entities

### ExecutionMode

Represents the selected depth profile for a feature run.

| Field | Type | Constraints | Notes |
|---|---|---|---|
| `value` | enum | Required; one of: `fast`, `balanced`, `detailed` | |
| `source` | enum | Required; one of: `user-selected`, `config-default`, `fallback` | Tracks whether user overrode the default |
| `selected_at` | ISO-8601 date | Required | Set when user confirms selection |

**Storage**: `specs/{feature}/.feature-config.json` as `{ "mode": "fast", "mode_source": "user-selected", "mode_selected_at": "2026-02-21" }`

**Default fallback**: `balanced` (if `.specify/config.json` has no `defaultMode` key and user does not select).

**Lifecycle**:
1. Feature created → mode prompt shown → user selects → written to `.feature-config.json`
2. Each subsequent command reads `.feature-config.json` to determine behavior
3. Mode may not change after artifacts are generated (mid-run mode switch is out of scope for v1)

---

### RiskTrigger

A detected keyword in the feature spec that elevates artifact requirements.

| Field | Type | Constraints | Notes |
|---|---|---|---|
| `keyword` | string | Non-empty | The exact keyword matched in the spec text |
| `context_line` | string | Optional | The line of spec text containing the match |

**Detection**: grep scan of `spec.md` (case-insensitive) against the v1 keyword catalog.

**Keyword catalog v1**: See `contracts/risk-triggers.md` for the canonical list (single source of truth).

**State transitions**:
- Not detected → no escalation (mode behavior unchanged)
- Detected during fast/balanced → notification shown, AR + SEC artifacts added, run continues

---

### ArtifactPolicy

Defines which artifacts are required, conditional, or skipped per mode and risk state.

| Mode | No Triggers | With Triggers |
|---|---|---|
| `fast` | spec.md, plan.md, run-summary.md | + ar.md, sec.md |
| `balanced` | spec.md, plan.md, run-summary.md | + ar.md, sec.md |
| `detailed` | spec.md, ar.md, sec.md, plan.md, run-summary.md | (same, triggers already included) |

**Invariants**:
- `run-summary.md` is always generated regardless of mode
- `plan.md` is always generated regardless of mode
- `spec.md` is always generated regardless of mode
- `tasks.md` is generated by `/speckit.tasks` (not affected by mode directly)

---

### RunSummary

A record of one `/speckit.plan` execution, written to `specs/{feature}/run-summary.md`.

| Field | Type | Constraints | Notes |
|---|---|---|---|
| `feature_branch` | string | Required | e.g., `001-adaptive-execution-modes` |
| `run_date` | ISO-8601 date | Required | |
| `execution_mode` | ExecutionMode.value | Required | |
| `mode_source` | ExecutionMode.source | Required | |
| `risk_triggers_detected` | string[] | Required; may be empty | List of matched keyword tokens |
| `artifacts_generated` | string[] | Required; min 2 | Filenames of produced artifacts |
| `estimated_token_count` | integer | Required | AI self-reported |
| `escalated` | boolean | Required | `true` if triggers caused AR/SEC to be added in fast/balanced |

**Storage**: `specs/{feature}/run-summary.md` (overwritten on each plan run)

---

### FeatureConfig

The per-feature metadata file that persists mode selection and future feature-level settings.

**File**: `specs/{feature}/.feature-config.json`

**Schema**:
```json
{
  "mode": "fast | balanced | detailed",
  "mode_source": "user-selected | config-default | fallback",
  "mode_selected_at": "YYYY-MM-DD"
}
```

**Read by**: `check-prerequisites.sh` (exposed in JSON output), all command templates.

**Written by**: AI during `/speckit.specify` after user confirms mode selection.

---

## Relationships

```
FeatureConfig (1) ──── (1) ExecutionMode
ExecutionMode (1) ──── (1..N) ArtifactPolicy  [one policy per mode]
RiskTrigger   (0..N) ─── (1) ArtifactPolicy  [triggers may expand policy]
RunSummary    (1) references ExecutionMode, RiskTrigger[], ArtifactPolicy
```

## Validation Rules

- `mode` must be exactly one of: `fast`, `balanced`, `detailed`
- An unsupported mode value at command start triggers an error with guidance to re-run `/speckit.specify`
- `risk_triggers_detected` is always a list (empty list when none detected, never null)
- `estimated_token_count` must be a positive integer
