---
description: Create a Product Requirements Document (PRD) with MoSCoW requirements, prioritized user stories, and formal review tiers.
handoffs:
  - label: Create Architecture Decision
    agent: speckit.architecture
    prompt: Design the technical architecture for this PRD
    send: true
  - label: Create Security Review
    agent: speckit.security
    prompt: Perform security review for this PRD
    send: true
scripts:
  sh: scripts/bash/create-new-feature.sh --json "{ARGS}"
  ps: scripts/powershell/create-new-feature.ps1 -Json "{ARGS}"
---

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

## Outline

The text the user typed after `/speckit.prd` in the triggering message **is** the feature description. Assume you always have it available in this conversation even if `{ARGS}` appears literally below. Do not ask the user to repeat it unless they provided an empty command.

Given that feature description, do this:

1. **Generate a concise short name** (2-4 words) for the branch:
   - Analyze the feature description and extract the most meaningful keywords
   - Create a 2-4 word short name that captures the essence of the feature
   - Use action-noun format when possible (e.g., "add-user-auth", "fix-payment-bug")
   - Preserve technical terms and acronyms (OAuth2, API, JWT, etc.)
   - Keep it concise but descriptive enough to understand the feature at a glance

2. **Check for existing branches before creating new one**:

   a. First, fetch all remote branches to ensure we have the latest information:

      ```bash
      git fetch --all --prune
      ```

   b. Find the highest feature number across all sources for the short-name:
      - Remote branches: `git ls-remote --heads origin | grep -E 'refs/heads/[0-9]+-<short-name>$'`
      - Local branches: `git branch | grep -E '^[* ]*[0-9]+-<short-name>$'`
      - Specs directories: Check for directories matching `specs/[0-9]+-<short-name>`

   c. Determine the next available number:
      - Extract all numbers from all three sources
      - Find the highest number N
      - Use N+1 for the new branch number

   d. Run the script `{SCRIPT}` with the calculated number and short-name:
      - Pass `--number N+1` and `--short-name "your-short-name"` along with the feature description
      - Bash example: `{SCRIPT} --json --number 5 --short-name "user-auth" "Add user authentication"`
      - PowerShell example: `{SCRIPT} -Json -Number 5 -ShortName "user-auth" "Add user authentication"`

   **IMPORTANT**:
   - Check all three sources (remote branches, local branches, specs directories) to find the highest number
   - Only match branches/directories with the exact short-name pattern
   - If no existing branches/directories found with this short-name, start with number 1
   - You must only ever run this script once per feature
   - The JSON is provided in the terminal as output - always refer to it to get the actual content you're looking for
   - The JSON output will contain:
     - `BRANCH_NAME`: The feature branch name
     - `SPEC_FILE`: Absolute path to spec.md
     - `FEATURE_ROOT`: **Working directory** - use this as the base for all file operations
     - `MODE`: Either "branch" (standard mode) or "worktree" (parallel development mode)
   - **When MODE is "worktree"**: The feature is in a separate working directory. Use `FEATURE_ROOT` as your working directory for all subsequent commands and file operations
   - For single quotes in args like "I'm Groot", use escape syntax: e.g 'I'\''m Groot' (or double-quote if possible: "I'm Groot")

3. Load `templates/prd-template.md` to understand required sections and structure.

4. Follow this execution flow:

    1. Parse user description from Input
       If empty: ERROR "No feature description provided"
    2. Extract key concepts from description
       Identify: actors, actions, data, constraints, business needs
    3. For unclear aspects:
       - Make informed guesses based on context and industry standards
       - Only mark with [NEEDS CLARIFICATION: specific question] if:
         - The choice significantly impacts feature scope or user experience
         - Multiple reasonable interpretations exist with different implications
         - No reasonable default exists
       - **LIMIT: Maximum 3 [NEEDS CLARIFICATION] markers total**
       - Prioritize clarifications by impact: scope > security/privacy > user experience > technical details
    4. Fill Problem Statement with business context
    5. Fill User Scenarios & Testing section with prioritized user stories
       - Each story must be independently testable
       - P1 should deliver a viable MVP on its own
       - Include acceptance scenarios in Given/When/Then format
       If no clear user flow: ERROR "Cannot determine user scenarios"
    6. Generate MoSCoW Requirements (Must/Should/Could/Won't Have)
       Each requirement must have a unique ID (M-1, S-1, etc.)
       Each requirement must be testable
    7. Fill Acceptance Criteria table referencing both Requirement IDs and User Story IDs
    8. Fill remaining sections: Technical Constraints, Data Model, Security Considerations, etc.
    9. All `@human-required` sections get best-effort drafts
    10. Return: SUCCESS (PRD ready for architecture/security review)

5. Write the PRD to `FEATURE_DIR/prd.md` (same directory as SPEC_FILE, but named `prd.md`) using the template structure, replacing placeholders with concrete details derived from the feature description while preserving section order and headings. Replace the Feature Branch metadata placeholders with actual values from the script output.

6. **Generate human review checklist** at the end of the PRD output:

   ```markdown
   ## Human Review Required

   The following sections need human review or input:

   - [ ] Background (@human-required) - Verify business context
   - [ ] Problem Statement (@human-required) - Validate problem framing
   - [ ] User Stories (@human-required) - Confirm priorities and acceptance scenarios
   - [ ] Must Have Requirements (@human-required) - Validate MVP scope
   - [ ] Should Have Requirements (@human-required) - Confirm priority
   - [ ] Selected Approach (@human-required) - Decision needed
   - [ ] Success Metrics (@human-required) - Define targets
   - [ ] Definition of Ready (@human-required) - Complete readiness checklist
   - [ ] All @human-review sections - Review LLM-drafted content
   ```

7. Report completion with branch name, PRD file path, and readiness for next phase (`/speckit.architecture` or `/speckit.security`).

   **CRITICAL - Worktree Mode Notification**: If `MODE` is `worktree`, you **MUST** include a prominent warning section at the end of your completion report:

   ```markdown
   ---

   ## ACTION REQUIRED: Switch to Worktree

   This feature was created in **worktree mode**. Your files are in a separate directory:

   **Worktree Path**: `[FEATURE_ROOT]`

   **You must switch your coding agent/IDE to this directory** before running any subsequent commands (`/speckit.architecture`, `/speckit.security`, `/speckit.tasks`, etc.).

   ```bash
   cd [FEATURE_ROOT]
   ```

   ---
   ```

   Replace `[FEATURE_ROOT]` with the actual path from the script output.

**NOTE:** The script creates and checks out the new branch and initializes an empty spec.md. This command writes `prd.md` alongside it. The empty `spec.md` can be left as-is or removed by the user.

## General Guidelines

- Focus on **WHAT** users need and **WHY** from a business perspective.
- Include technical constraints but avoid prescribing HOW to implement.
- Use MoSCoW prioritization consistently.
- Ensure traceability: every requirement has an ID, every AC references a requirement and user story.
- All `@human-required` sections should have best-effort drafts, not empty placeholders.
